<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Redirect</title>
    <script>
        // Extract OAuth parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // For Facebook (token in fragment)
        const accessToken = hashParams.get('access_token');
        const expiresIn = hashParams.get('expires_in');
        
        // For Google (code in query)
        const code = urlParams.get('code');
        // State can be in query (Google) or fragment (Facebook)
        const state = urlParams.get('state') || hashParams.get('state');
        const error = urlParams.get('error') || hashParams.get('error');
        
        // Get provider from query params, state parameter, or default
        // First try query params (for backward compatibility)
        let provider = urlParams.get('provider');
        
        // If not in query, try to extract from state parameter
        if (!provider && state) {
            try {
                // State format: base64(provider:uuid)
                const decodedState = atob(state);
                const parts = decodedState.split(':');
                if (parts.length >= 1) {
                    provider = parts[0];
                }
            } catch (e) {
                // If decoding fails, use default
                console.log('Could not decode state:', e);
            }
        }
        
        // Default to instagram if still not found
        provider = provider || 'instagram';
        
        // Debug logging
        console.log('OAuth Redirect Debug:');
        console.log('  Provider:', provider);
        console.log('  Access Token:', accessToken ? 'present' : 'missing');
        console.log('  Code:', code ? 'present' : 'missing');
        console.log('  State:', state);
        console.log('  Error:', error);
        
        // Build redirect URL
        let redirectURL = 'auriyastudio://oauth-callback?provider=' + provider;
        
        if (error) {
            // Redirect with error
            redirectURL += '&error=' + encodeURIComponent(error);
        } else if (accessToken) {
            // Facebook OAuth - token in fragment
            redirectURL += '#access_token=' + encodeURIComponent(accessToken);
            if (expiresIn) {
                redirectURL += '&expires_in=' + encodeURIComponent(expiresIn);
            }
        } else if (code) {
            // Google OAuth - code in query
            redirectURL += '&code=' + encodeURIComponent(code);
            if (state) {
                redirectURL += '&state=' + encodeURIComponent(state);
            }
        }
        
        // Redirect to app
        window.location.href = redirectURL;
    </script>
</head>
<body>
    <p>Redirecting to Auriya Studio...</p>
    <p>If you are not redirected automatically, <a href="auriyastudio://oauth-callback">click here</a>.</p>
</body>
</html>
