<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Redirect</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        .container {
            max-width: 500px;
        }
        h1 {
            margin-bottom: 1rem;
        }
        p {
            margin: 0.5rem 0;
        }
        a {
            color: white;
            text-decoration: underline;
        }
        .error {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
    <script>
        // Extract OAuth parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // For Facebook (token in fragment)
        const accessToken = hashParams.get('access_token');
        const expiresIn = hashParams.get('expires_in');
        
        // For Google (code in query)
        const code = urlParams.get('code');
        // State can be in query (Google) or fragment (Facebook)
        const state = urlParams.get('state') || hashParams.get('state');
        const error = urlParams.get('error') || hashParams.get('error');
        
        // Get provider from query params, state parameter, or default
        // First try query params (for backward compatibility)
        let provider = urlParams.get('provider');
        
        // If not in query, try to extract from state parameter
        if (!provider && state) {
            try {
                // State format: URL-safe base64(provider:uuid)
                // Convert URL-safe base64 back to standard base64
                // Replace - with +, _ with /, and add padding if needed
                let base64State = state.replace(/-/g, '+').replace(/_/g, '/');
                // Add padding if needed (base64 strings should be multiple of 4)
                while (base64State.length % 4) {
                    base64State += '=';
                }
                const decodedState = atob(base64State);
                const parts = decodedState.split(':');
                if (parts.length >= 1) {
                    provider = parts[0];
                }
            } catch (e) {
                // If decoding fails, use default
                console.log('Could not decode state:', e);
            }
        }
        
        // Default based on OAuth data type
        // If we have a code (Google OAuth), default to youtube
        // If we have access_token (Facebook OAuth), default to instagram
        if (!provider) {
            if (code) {
                provider = 'youtube'; // Google OAuth code means YouTube
            } else {
                provider = 'instagram'; // Facebook token means Instagram
            }
        }
        
        // Debug logging
        console.log('OAuth Redirect Debug:');
        console.log('  Provider:', provider);
        console.log('  Access Token:', accessToken ? 'present' : 'missing');
        console.log('  Code:', code ? 'present' : 'missing');
        console.log('  State:', state);
        console.log('  Error:', error);
        
        // Only redirect if we have OAuth data (token, code, or error)
        if (accessToken || code || error) {
            // Build redirect URL
            let redirectURL = 'auriyastudio://oauth-callback?provider=' + provider;
            
            if (error) {
                // Redirect with error
                redirectURL += '&error=' + encodeURIComponent(error);
            } else if (accessToken) {
                // Facebook OAuth - token in fragment
                // Also add to query parameters as fallback (in case fragment is lost)
                redirectURL += '&access_token=' + encodeURIComponent(accessToken);
                if (expiresIn) {
                    redirectURL += '&expires_in=' + encodeURIComponent(expiresIn);
                }
                // Add fragment for primary token location
                redirectURL += '#access_token=' + encodeURIComponent(accessToken);
                if (expiresIn) {
                    redirectURL += '&expires_in=' + encodeURIComponent(expiresIn);
                }
            } else if (code) {
                // Google OAuth - code in query
                redirectURL += '&code=' + encodeURIComponent(code);
                if (state) {
                    redirectURL += '&state=' + encodeURIComponent(state);
                }
            }
            
            // Redirect to app
            console.log('Redirecting to:', redirectURL);
            window.location.href = redirectURL;
        } else {
            // No OAuth data - show message instead of redirecting
            console.log('No OAuth data found - this is a test page');
            document.body.innerHTML = `
                <div class="container">
                    <h1>Auriya Studio</h1>
                    <p>OAuth Redirect Endpoint</p>
                    <div class="error">
                        <p><strong>No OAuth data received</strong></p>
                        <p>This endpoint is used for OAuth callbacks from Facebook and Google.</p>
                        <p>If you're testing the OAuth flow, initiate it from the iOS app.</p>
                    </div>
                    <p style="margin-top: 2rem;">
                        <a href="auriyastudio://oauth-callback?provider=instagram">Test App Link (will only work if app is installed)</a>
                    </p>
                </div>
            `;
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Auriya Studio</h1>
        <p>Redirecting to Auriya Studio...</p>
        <p>If you are not redirected automatically, <a href="auriyastudio://oauth-callback">click here</a>.</p>
    </div>
</body>
</html>
